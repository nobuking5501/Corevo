# 00_concept.md - プロジェクトコンセプト

## プロジェクト概要

**Corevo（コアエボ）** は、美容サロン（特に脱毛サロン）向けの経営統合プラットフォームです。

### 基本理念

```
「美容サロン経営者を数字とAIで支える」
```

## 目的

### ビジネス目的
1. **サロン経営の可視化**: KPI・メトリクスで経営状態を即座に把握
2. **継続率向上**: AIによる失客予兆検知と自動フォロー提案
3. **意思決定の高速化**: 前計算済みダッシュボードで瞬時に現状把握
4. **PDCA促進**: データドリブンな改善サイクルの実現

### 技術的目的
1. **マルチテナントSaaSの確立**: 完全分離された安全なデータ管理
2. **前計算主義の徹底**: リアルタイム集計を避け、夜間バッチで事前計算
3. **承認制AIの実現**: 人間が必ず確認・承認してから顧客へ送信
4. **保守性の高いコードベース**: TypeScript strict mode、明確な型定義、テスト

## ビジョン

### 短期（6ヶ月）
- 売上・経費・広告管理の完全実装
- AI提案（NBA: Next Best Action）の精度向上
- Google Calendar / LINE 完全連携

### 中期（1年）
- 複数店舗運営（Organization > Tenants）のスケール
- 予測精度の向上（売上予測・失客予測）
- 外部連携拡大（会計ソフト、POSシステム）

### 長期（2年以降）
- 業界標準プラットフォームとしての地位確立
- 他業種（エステ、ネイル、整体等）への横展開
- APIエコシステムの構築

## アーキテクチャ方針

### 1. 前計算主義（Pre-calculation First）

**原則**: ダッシュボードは生データを集計しない

- ❌ 悪い例: `appointments` コレクションを毎回集計
- ✅ 良い例: 夜間バッチで計算済みの `metrics` コレクションを参照

**理由**:
- Firestoreの課金削減（読み取り回数削減）
- レスポンス速度向上
- 複雑な集計ロジックの一元管理

### 2. 承認制AI（Human-in-the-Loop AI）

**原則**: AIが生成した提案は人間が必ず承認してから送信

- AI提案 → `ai_suggestions` コレクションに保存 → 人間が承認 → `messages` に移動 → 送信

**理由**:
- 顧客への不適切なメッセージ送信防止
- ブランド保護
- 法的リスク回避

### 3. マルチテナント完全分離

**原則**: データは `tenants/{tenantId}/` 配下に格納し、Security Rulesで完全分離

- Custom Claims で `tenantIds` 配列を管理
- すべてのAPI/クエリで `tenantId` を検証

**理由**:
- データ漏洩の完全防止
- コンプライアンス対応
- B2B SaaSの信頼性確保

### 4. PC/スマホUI最適化

**原則**:
- **PC**: 経営者・マネージャー向け（ダッシュボード、分析、設定）
- **スマホ**: スタッフ向け（今日の予約、カルテ入力、簡易承認）

**理由**:
- ユーザー体験の最適化
- 現場スタッフの使いやすさ重視
- 経営者は詳細分析、スタッフは素早い入力

### 5. TypeScript Strict Mode

**原則**: すべてのコードでTypeScript strict mode + Zodバリデーション

**理由**:
- 型安全性による実行時エラー削減
- リファクタリングの安全性向上
- コードの自己文書化

## 技術スタック選定理由

| 技術 | 選定理由 |
|------|----------|
| **Next.js 14 (App Router)** | SSR/SSG対応、SEO、高速レンダリング、React Server Components |
| **Firebase** | マネージドサービスで運用コスト削減、リアルタイム同期、Security Rules |
| **Firestore** | NoSQL、スケーラビリティ、オフライン対応、リアルタイムリスナー |
| **Cloud Functions** | サーバーレス、自動スケール、Firestore統合 |
| **Zustand** | 軽量、シンプル、TypeScript親和性、Reduxより学習コスト低 |
| **shadcn/ui + Tailwind CSS** | 高品質コンポーネント、カスタマイズ性、アクセシビリティ |
| **Zod** | 実行時型検証、TypeScript型推論、安全なAPI入力 |
| **Stripe** | 業界標準決済、サブスクリプション管理、PCI DSS準拠 |
| **Claude API** | 高精度AI、日本語対応、長文コンテキスト、Function Calling |

## 非機能要件

### パフォーマンス
- **ダッシュボード初期表示**: 2秒以内
- **予約作成**: 1秒以内
- **検索**: 500ms以内

### セキュリティ
- **認証**: Firebase Authentication (Email/Password)
- **認可**: Custom Claims + Security Rules
- **データ分離**: tenantId完全分離
- **監査ログ**: 重要操作はすべて記録

### 可用性
- **稼働率**: 99.9%（Firebaseのマネージドサービスに依存）
- **バックアップ**: 日次自動バックアップ
- **復旧時間**: 4時間以内

### スケーラビリティ
- **想定テナント数**: 1,000店舗
- **テナント当たり顧客数**: 10,000名
- **同時接続数**: 500ユーザー

## 開発方針

### コードレビュー
- すべてのlegacy変更は05_decisions.mdに記録
- セキュリティ影響のある変更は必ず人間がレビュー

### テスト
- **単体テスト**: Firebase Functions（Jest）
- **E2Eテスト**: 主要フロー（Playwright）※今後導入
- **手動テスト**: 新機能リリース前に必ず実施

### デプロイ
- **開発環境**: Emulator使用
- **本番環境**: Firebase Hosting + Functions
- **デプロイ頻度**: オンデマンド（人間の指示時のみ）

### ドキュメント
- **コード**: JSDocコメント（複雑な関数のみ）
- **API**: 型定義で自己文書化
- **アーキテクチャ**: `/core` および `/docs` で管理

## 制約事項

### 技術的制約
- **Firestore制限**: 1ドキュメント1MB、1トランザクション500ドキュメント
- **Functions制限**: 実行時間9分、メモリ4GB
- **リージョン**: asia-northeast1（東京）固定

### ビジネス的制約
- **対象業種**: 美容サロン（脱毛、エステ）
- **対象規模**: 個人経営〜10店舗程度のチェーン
- **言語**: 日本語のみ

## 今後の課題

### 技術的課題
1. テストカバレッジの向上（現状: 未実装）
2. E2Eテスト自動化の導入
3. パフォーマンスモニタリングの強化
4. エラー追跡（Sentry等）の導入

### ビジネス的課題
1. 予測精度の継続的改善
2. ユーザーオンボーディングの最適化
3. サポート体制の構築
4. マーケティング戦略の確立

---

**最終更新**: 2026-01-23
**次回見直し**: 3ヶ月後
